import { createContext, useContext, useState, useCallback, type ReactNode } from "react";

export type Lang = "zh" | "en";

const translations = {
  zh: {
    appTitle: "排球計分器",
    signIn: "登入",
    signInDesc: "登入以管理你的比賽",
    username: "帳號",
    password: "密碼",
    enterUsername: "請輸入帳號",
    enterPassword: "請輸入密碼",
    signingIn: "登入中...",
    defaultCredentials: "預設帳號：admin / admin123",
    loginFailed: "登入失敗",
    pleaseEnterCredentials: "請輸入帳號和密碼",

    myTeams: "我的隊伍",
    newTeam: "新增隊伍",
    teamName: "隊伍名稱",
    teamNamePlaceholder: "例如：快攻隊",
    createTeam: "建立",
    noTeamsYet: "尚無隊伍",
    createFirstTeam: "建立你的隊伍，在比賽中自動帶入隊伍名稱",
    teamDeleteFailed: "刪除隊伍失敗",
    teamCreateFailed: "建立隊伍失敗",
    enterTeamName: "請輸入隊伍名稱",
    selectTeam: "選擇隊伍",
    selectTeamPlaceholder: "選擇我方隊伍",
    manualInput: "手動輸入",

    myTournaments: "我的杯賽",
    newTournament: "新增杯賽",
    tournamentName: "杯賽名稱",
    tournamentNamePlaceholder: "例如：2026 春季盃",
    createTournament: "建立",
    cancel: "取消",
    noTournamentsYet: "尚無杯賽",
    createFirstTournament: "建立你的第一個杯賽開始管理比賽",
    deleteTournament: "刪除杯賽",
    deleteTournamentConfirm: "確定要刪除此杯賽嗎？",
    cannotDeleteWithMatches: "無法刪除含有比賽的杯賽",
    tournamentDeleteFailed: "刪除杯賽失敗",
    tournamentCreateFailed: "建立杯賽失敗",
    enterTournamentName: "請輸入杯賽名稱",
    scoringRules: "計分規則",
    setFormat: "局數制度",
    singleSet: "單局勝利",
    bestOf3: "三戰兩勝",
    bestOf5: "五戰三勝",
    bestOf7: "七戰四勝",
    regularSetPoints: "一般局分數",
    finalSetPoints: "最終局分數",
    pointsUnit: "分",

    myMatches: "我的比賽",
    newMatch: "新增比賽",
    noMatchesYet: "尚無比賽紀錄",
    createFirstMatch: "建立你的第一場比賽開始計分",
    all: "全部",
    inProgress: "進行中",
    completed: "已完成",
    match: "場",
    matches_: "場",
    live: "進行中",
    noFilteredMatches: (status: string) => `沒有${status}的比賽`,

    matchDetails: "比賽資訊",
    enterMatchInfo: "輸入比賽資訊以開始計分",
    date: "日期",
    time: "時間",
    tournament: "杯賽",
    tournamentPlaceholder: "例如：2026 春季盃",
    matchNumber: "場次",
    matchNumberPlaceholder: "例如：1、A1、準決賽",
    ourTeam: "我方隊伍",
    ourTeamPlaceholder: "我方隊伍名稱",
    opponentTeam: "對手隊伍",
    opponentTeamPlaceholder: "對手隊伍名稱",
    startMatch: "開始比賽",
    creating: "建立中...",
    fillAllFields: "請填寫所有欄位",
    createFailed: "建立比賽失敗",

    vs: "VS",
    end: "結束",
    matchCompleted: "比賽已結束！",
    completedLabel: "已完成",
    pointLog: "得分紀錄",
    points: "分",
    noPointsYet: "尚無得分紀錄。按下隊伍按鈕開始計分。",
    addNote: "點擊新增備註",
    notePlaceholder: "新增備註...",
    scoreFailed: "記分失敗",
    undoFailed: "撤銷失敗",
    updateNoteFailed: "更新備註失敗",
    updateScoringTeamFailed: "修改得分隊伍失敗",
    completeFailed: "結束比賽失敗",
    tapToChangeTeam: "點擊切換得分隊伍",
    verticalView: "直式",
    horizontalView: "橫式",
    set: "局",
    currentSet: "當前局",
    setN: (n: number) => `第 ${n} 局`,
    setsWon: "局數",
    setCompleted: "本局結束",
    nextSet: "下一局",
    deuce: "Deuce",
    matchNotFound: "找不到比賽",
    backToDashboard: "返回列表",
    backToTournament: "返回杯賽",
    logoutFailed: "登出失敗",

    players: "選手",
    addPlayer: "新增選手",
    playerName: "姓名",
    playerNamePlaceholder: "選手姓名",
    jerseyNumber: "背號",
    jerseyNumberPlaceholder: "背號",
    age: "年齡",
    agePlaceholder: "年齡",
    grade: "年級",
    gradePlaceholder: "年級",
    noPlayersYet: "尚無選手",
    addFirstPlayer: "新增選手到隊伍中",
    playerCreateFailed: "新增選手失敗",
    playerDeleteFailed: "刪除選手失敗",
    playerUpdateFailed: "更新選手失敗",
    enterPlayerNameAndNumber: "請輸入選手姓名和背號",
    swapJersey: "交換背號",
    swapJerseyDesc: "選擇兩位選手交換背號",
    swapJerseyFailed: "交換背號失敗",
    managePlayersDesc: "管理隊伍選手（姓名、背號、年齡、年級）",

    selectLineup: "選擇先發陣容",
    lineupDesc: "選擇 6 位先發選手 + 1 位自由球員",
    starter: "先發",
    libero: "自由球員",
    bench: "板凳",
    lineupSaved: "陣容已儲存",
    lineupSaveFailed: "儲存陣容失敗",
    mustSelect6And1: "必須選擇 6 位先發和 1 位自由球員",
    currentLineup: "目前陣容",
    noLineupYet: "尚未選擇陣容",

    substitution: "換人",
    substitutePlayer: "替換選手",
    playerOut: "換下",
    playerIn: "換上",
    substitutionLog: "換人記錄",
    substitutionFailed: "換人失敗",
    noSubstitutions: "尚無換人記錄",
    atPoint: "第 {0} 分時",

    scorer: "得分選手",
    loser: "失分選手",
    selectScorer: "選擇得分選手",
    selectLoser: "選擇失分選手",
    scoringMethod: "得分/失分方式",

    exportMatch: "匯出比賽記錄",
    exportTournament: "匯出賽事記錄",
    exportPlayer: "匯出選手記錄",
    exportDesc: "匯出得分/失分記錄表",

    teamMembers: "隊伍管理員",
    inviteMember: "邀請管理員",
    emailPlaceholder: "Gmail 地址",
    invite: "邀請",
    inviteFailed: "邀請失敗",
    alreadyInvited: "已邀請",
    removeMember: "移除",
    transferAdmin: "移轉管理權",
    transferAdminConfirm: "確定要將管理權移轉給此帳號嗎？",
    transferAdminFailed: "移轉管理權失敗",
    admin: "管理者",
    member: "成員",
    invited: "已邀請",
    active: "已啟用",
    owner: "擁有者",
    save: "儲存",
    edit: "編輯",
    delete_: "刪除",
    confirm: "確認",
    close: "關閉",
    actions: "操作",
  },
  en: {
    appTitle: "Volleyball Scorer",
    signIn: "Sign In",
    signInDesc: "Sign in to manage your matches",
    username: "Username",
    password: "Password",
    enterUsername: "Enter username",
    enterPassword: "Enter password",
    signingIn: "Signing in...",
    defaultCredentials: "Default: admin / admin123",
    loginFailed: "Login failed",
    pleaseEnterCredentials: "Please enter username and password",

    myTeams: "My Teams",
    newTeam: "New Team",
    teamName: "Team Name",
    teamNamePlaceholder: "e.g. Thunder Squad",
    createTeam: "Create",
    noTeamsYet: "No teams yet",
    createFirstTeam: "Create your team to auto-fill team name in matches",
    teamDeleteFailed: "Failed to delete team",
    teamCreateFailed: "Failed to create team",
    enterTeamName: "Please enter team name",
    selectTeam: "Select Team",
    selectTeamPlaceholder: "Select our team",
    manualInput: "Manual input",

    myTournaments: "My Tournaments",
    newTournament: "New Tournament",
    tournamentName: "Tournament Name",
    tournamentNamePlaceholder: "e.g. Spring Cup 2026",
    createTournament: "Create",
    cancel: "Cancel",
    noTournamentsYet: "No tournaments yet",
    createFirstTournament: "Create your first tournament to manage matches",
    deleteTournament: "Delete Tournament",
    deleteTournamentConfirm: "Are you sure you want to delete this tournament?",
    cannotDeleteWithMatches: "Cannot delete tournament with matches",
    tournamentDeleteFailed: "Failed to delete tournament",
    tournamentCreateFailed: "Failed to create tournament",
    enterTournamentName: "Please enter tournament name",
    scoringRules: "Scoring Rules",
    setFormat: "Set Format",
    singleSet: "Single Set",
    bestOf3: "Best of 3",
    bestOf5: "Best of 5",
    bestOf7: "Best of 7",
    regularSetPoints: "Regular Set Points",
    finalSetPoints: "Final Set Points",
    pointsUnit: "pts",

    myMatches: "My Matches",
    newMatch: "New Match",
    noMatchesYet: "No matches yet",
    createFirstMatch: "Create your first match to start scoring",
    all: "All",
    inProgress: "In Progress",
    completed: "Completed",
    match: "match",
    matches_: "matches",
    live: "live",
    noFilteredMatches: (status: string) => `No ${status} matches`,

    matchDetails: "Match Details",
    enterMatchInfo: "Enter match information to start scoring",
    date: "Date",
    time: "Time",
    tournament: "Tournament",
    tournamentPlaceholder: "e.g. Spring Cup 2026",
    matchNumber: "Match Number",
    matchNumberPlaceholder: "e.g. 1, A1, Semi-final",
    ourTeam: "Our Team",
    ourTeamPlaceholder: "Our team name",
    opponentTeam: "Opponent",
    opponentTeamPlaceholder: "Opponent team name",
    startMatch: "Start Match",
    creating: "Creating...",
    fillAllFields: "Please fill in all fields",
    createFailed: "Failed to create match",

    vs: "VS",
    end: "End",
    matchCompleted: "Match completed!",
    completedLabel: "Completed",
    pointLog: "Point Log",
    points: "points",
    noPointsYet: "No points recorded yet. Press a team button to score.",
    addNote: "click to add note",
    notePlaceholder: "Add note...",
    scoreFailed: "Failed to record point",
    undoFailed: "Failed to undo",
    updateNoteFailed: "Failed to update note",
    updateScoringTeamFailed: "Failed to update scoring team",
    completeFailed: "Failed to complete match",
    tapToChangeTeam: "Tap to change scoring team",
    verticalView: "Vertical",
    horizontalView: "Horizontal",
    set: "Set",
    currentSet: "Current Set",
    setN: (n: number) => `Set ${n}`,
    setsWon: "Sets",
    setCompleted: "Set Completed",
    nextSet: "Next Set",
    deuce: "Deuce",
    matchNotFound: "Match not found",
    backToDashboard: "Back to Dashboard",
    backToTournament: "Back to Tournament",
    logoutFailed: "Logout failed",

    players: "Players",
    addPlayer: "Add Player",
    playerName: "Name",
    playerNamePlaceholder: "Player name",
    jerseyNumber: "Jersey #",
    jerseyNumberPlaceholder: "Jersey #",
    age: "Age",
    agePlaceholder: "Age",
    grade: "Grade",
    gradePlaceholder: "Grade",
    noPlayersYet: "No players yet",
    addFirstPlayer: "Add players to your team",
    playerCreateFailed: "Failed to add player",
    playerDeleteFailed: "Failed to delete player",
    playerUpdateFailed: "Failed to update player",
    enterPlayerNameAndNumber: "Please enter player name and jersey number",
    swapJersey: "Swap Jersey",
    swapJerseyDesc: "Select two players to swap jersey numbers",
    swapJerseyFailed: "Failed to swap jersey numbers",
    managePlayersDesc: "Manage team players (name, jersey #, age, grade)",

    selectLineup: "Select Lineup",
    lineupDesc: "Select 6 starters + 1 libero",
    starter: "Starter",
    libero: "Libero",
    bench: "Bench",
    lineupSaved: "Lineup saved",
    lineupSaveFailed: "Failed to save lineup",
    mustSelect6And1: "Must select 6 starters and 1 libero",
    currentLineup: "Current Lineup",
    noLineupYet: "No lineup selected yet",

    substitution: "Substitution",
    substitutePlayer: "Substitute Player",
    playerOut: "Out",
    playerIn: "In",
    substitutionLog: "Substitution Log",
    substitutionFailed: "Substitution failed",
    noSubstitutions: "No substitutions yet",
    atPoint: "At point {0}",

    scorer: "Scorer",
    loser: "Loser",
    selectScorer: "Select scorer",
    selectLoser: "Select loser",
    scoringMethod: "Scoring/losing method",

    exportMatch: "Export Match Record",
    exportTournament: "Export Tournament Record",
    exportPlayer: "Export Player Record",
    exportDesc: "Export scoring/losing records",

    teamMembers: "Team Managers",
    inviteMember: "Invite Manager",
    emailPlaceholder: "Gmail address",
    invite: "Invite",
    inviteFailed: "Invite failed",
    alreadyInvited: "Already invited",
    removeMember: "Remove",
    transferAdmin: "Transfer Admin",
    transferAdminConfirm: "Are you sure you want to transfer admin rights to this account?",
    transferAdminFailed: "Failed to transfer admin rights",
    admin: "Admin",
    member: "Member",
    invited: "Invited",
    active: "Active",
    owner: "Owner",
    save: "Save",
    edit: "Edit",
    delete_: "Delete",
    confirm: "Confirm",
    close: "Close",
    actions: "Actions",
  },
} as const;

type Translations = {
  [K in keyof typeof translations.en]: (typeof translations.en)[K] extends (...args: infer A) => infer R
    ? (...args: A) => R
    : string;
};

interface I18nContextType {
  lang: Lang;
  t: Translations;
  toggleLang: () => void;
}

const I18nContext = createContext<I18nContextType | null>(null);

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLang] = useState<Lang>(() => {
    const saved = localStorage.getItem("volleyball-lang");
    return (saved === "en" || saved === "zh") ? saved : "zh";
  });

  const toggleLang = useCallback(() => {
    setLang((prev) => {
      const next = prev === "zh" ? "en" : "zh";
      localStorage.setItem("volleyball-lang", next);
      return next;
    });
  }, []);

  const t = translations[lang];

  return (
    <I18nContext.Provider value={{ lang, t, toggleLang }}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error("useI18n must be used within I18nProvider");
  return ctx;
}
